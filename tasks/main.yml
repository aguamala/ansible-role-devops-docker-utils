---
# tasks file for ansible-role-devops-docker-utils


#- name: copia credenciales de artifactory
#  template: src=dockercfg dest=/home/git/.dockercfg owner=centos group=centos

#- name: copia credenciales de artifactory
#  template: src=dockercfg dest=/root/.dockercfg owner=centos group=centos

- name: create docker-compose dir
  file: path="{{ devops_docker_utils.compose_dir }}"  state=directory recurse=yes owner={{ devops_docker_utils.user }} group={{ devops_docker_utils.user }}

- name: create docker-compose assemble dir
  file: path="{{ devops_docker_utils.compose_dir }}/assemble"  state=directory recurse=yes owner={{ devops_docker_utils.user }} group={{ devops_docker_utils.user }}

- name: copy consul template
  template: src=docker-compose-consul.yml dest="{{ devops_docker_utils.compose_dir }}/assemble/0_consul.yml"  owner={{ devops_docker_utils.user }} group={{ devops_docker_utils.user }}
  when: devops_docker_utils.consul is defined
  tags: consul

- name: copy registrator template
  template: src=docker-compose-registrator.yml dest="{{ devops_docker_utils.compose_dir }}/assemble/1_registrator.yml"  owner={{ devops_docker_utils.user }} group={{ devops_docker_utils.user }}
  when: devops_docker_utils.registrator is defined
  tags: registrator

- name: copy logspout template
  template: src=docker-compose-logspout.yml dest="{{ devops_docker_utils.compose_dir }}/assemble/2_logspout.yml"  owner={{ devops_docker_utils.user }} group={{ devops_docker_utils.user }}
  when: devops_docker_utils.logspout is defined
  tags: logspout

- name: assemble docker-compose files
  assemble: src="{{ devops_docker_utils.compose_dir }}/assemble/" dest="{{ devops_docker_utils.compose_dir }}/docker-compose.yml" owner={{ devops_docker_utils.user }} group={{ devops_docker_utils.user }}
  tags: docker_compose

- name: docker-compose up
  shell: /usr/bin/docker-compose up -d chdir="{{ devops_docker_utils.compose_dir }}"
